name: "[Demo](AI Service) HuggingFace Spaces Hexagonal Architecture Deployment"

on:
  push:
    branches: [ demo_ai-rag ]
    paths:
      - 'ai-service/**'
  pull_request:
    branches: [ demo_ai-rag ]
    paths:
      - 'ai-service/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: demo ai rag
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd ai-service/demo
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock
        
    - name: Run Demo Tests
      run: |
        cd ai-service/demo
        echo "ğŸ§ª Running Demo tests before deployment..."
        
        # ìœ ë‹› í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        python tests/scripts/run_unit_tests.py --coverage
        
        # ê¸°ë³¸ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        python tests/scripts/run_basic_tests.py --coverage
        
        echo "âœ… All tests passed successfully!"
        
    - name: Upload Test Coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./ai-service/demo/htmlcov/coverage.xml
        flags: demo-tests
        name: demo-tests-coverage
        fail_ci_if_error: false
        
    - name: Prepare HuggingFace Spaces files
      run: |
        cd ai-service/demo
        
        echo "ğŸ“¦ Preparing Hexagonal Architecture demo for HuggingFace Spaces..."
        
        # Copy Hexagonal Architecture specific files
        cp deployment/README_HF.md README.md
        cp deployment/Dockerfile.demo Dockerfile
        cp requirements.txt requirements.txt  # HuggingFace Spacesìš©ìœ¼ë¡œ ë³µì‚¬
        
        # Validate all required files are present
        echo "ğŸ“‹ Validating deployment files..."
        for file in "main.py" "README.md" "Dockerfile" "requirements.txt"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing deployment file: $file"
            exit 1
          fi
          echo "âœ… Ready: $file"
        done
        
        # Show directory structure for debugging
        echo "ğŸ“ Final directory structure:"
        find . -type f -name "*.py" | head -20
        
    - name: Deploy to HuggingFace Spaces
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_USERNAME: ${{ secrets.HF_USERNAME }}
      run: |
        cd ai-service/demo
        python -c "
        from huggingface_hub import HfApi, create_repo
        import os
        
        api = HfApi(token=os.environ['HF_TOKEN'])
        repo_id = f\"{os.environ['HF_USERNAME']}/ai-portfolio-rag-demo\"
        
        print(f'ğŸš€ Deploying Hexagonal Architecture RAG Demo to {repo_id}')
        
        try:
            # Create space if it doesn't exist
            create_repo(
                repo_id=repo_id,
                repo_type='space',
                space_sdk='gradio',
                token=os.environ['HF_TOKEN'],
                exist_ok=True
            )
            print(f'âœ… Space {repo_id} ready')
            
            # Upload Hexagonal Architecture files
            api.upload_folder(
                folder_path='.',
                repo_id=repo_id,
                repo_type='space',
                token=os.environ['HF_TOKEN'],
                ignore_patterns=[
                    '__pycache__', 
                    '*.pyc', 
                    'docker-compose*', 
                    'Dockerfile.dev*',
                    'deployment/',
                    'scripts/',
                    'tests/',
                    '.pytest_cache',
                    'config.yaml',
                    'test_*.py'
                ]
            )
            print(f'âœ… Hexagonal Architecture files uploaded to {repo_id}')
            
            # Verify key files were uploaded
            files = api.list_repo_files(repo_id=repo_id, repo_type='space')
            required_files = ['main.py', 'README.md', 'requirements.txt', 'Dockerfile']
            
            missing_files = [f for f in required_files if f not in files]
            if missing_files:
                raise Exception(f'Missing required files: {missing_files}')
            
            print(f'âœ… All required files verified: {required_files}')
            
        except Exception as e:
            print(f'âŒ Deployment failed: {e}')
            raise e
        "
        
    - name: Verify Deployment
      run: |
        echo "ğŸ‰ Hexagonal Architecture RAG Demo deployed successfully!"
        echo ""
        echo "ğŸ”— Demo URL: https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/ai-portfolio-rag-demo"
        echo "âš™ï¸  Settings: https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/ai-portfolio-rag-demo/settings"
        echo "ğŸ“Š Logs: https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/ai-portfolio-rag-demo/logs"
        echo ""
        echo "âœ¨ Features deployed:"
        echo "  â€¢ Hexagonal Architecture (Ports & Adapters)"
        echo "  â€¢ Real vector embeddings (sentence-transformers)"
        echo "  â€¢ Interactive document processing"
        echo "  â€¢ Live RAG pipeline demonstration"
        echo "  â€¢ Clean separation of concerns"
        echo "  â€¢ ğŸ“š Auto sample data loading"
        echo "  â€¢ ğŸ’¡ Pre-defined sample queries"
        echo "  â€¢ ğŸ” Advanced search analysis"
        echo "  â€¢ ğŸ§ª Comprehensive test coverage"
        echo "  â€¢ ğŸš€ CI/CD automated deployment"
        echo ""
        echo "ğŸš€ The demo will be available in 2-3 minutes at the URL above!"