name: "[Demo] AI Service â†’ HuggingFace Spaces"

on:
  push:
    branches: [ stage, main ]
    paths:
      - 'ai-service/demo/**'
  pull_request:
    branches: [ stage, main ]
    paths:
      - 'ai-service/demo/**'

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    environment: demo ai rag
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Python dependencies
      run: |
        cd ai-service/demo
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock
        
    - name: Install Playwright dependencies
      run: |
        cd ai-service/demo/tests/e2e
        npm install
        npx playwright install --with-deps chromium
        
    - name: Run Unit Tests
      run: |
        cd ai-service/demo
        echo "ðŸ§ª Running Unit tests..."
        python tests/scripts/run_unit_tests.py --coverage
        
    - name: Run Integration Tests
      run: |
        cd ai-service/demo
        echo "ðŸ”— Running Integration tests..."
        python tests/scripts/run_basic_tests.py --coverage
        
    - name: Start Demo Application for E2E Tests
      run: |
        cd ai-service/demo
        echo "ðŸš€ Starting demo application for E2E tests..."
        python main.py &
        sleep 30  # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œìž‘ ëŒ€ê¸°
        
    - name: Run Playwright E2E Tests
      run: |
        cd ai-service/demo/tests/e2e
        echo "ðŸŽ­ Running Playwright E2E tests..."
        npx playwright test --reporter=html,json
        
    - name: Upload Test Coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./ai-service/demo/htmlcov/coverage.xml
        flags: production-tests
        name: production-tests-coverage
        fail_ci_if_error: false
        
    - name: Upload Playwright Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: ai-service/demo/tests/e2e/reports/
        retention-days: 30
        
    - name: Prepare HuggingFace Spaces files
      run: |
        cd ai-service/demo
        
        echo "ðŸ“¦ Preparing Hexagonal Architecture demo for HuggingFace Spaces..."
        
        # Create README for HuggingFace Spaces
        cat > README.md << 'EOF'
# AI Portfolio RAG Demo - Hexagonal Architecture

## ðŸ—ï¸ Architecture Overview

This demo showcases a **Hexagonal Architecture (Ports & Adapters)** implementation for a RAG (Retrieval-Augmented Generation) system. The architecture ensures clean separation of concerns and high testability.

## âœ¨ Features

- **ðŸ“š Document Management**: Upload and process various document formats
- **ðŸ” Advanced Chunking**: Intelligent text splitting with overlap
- **ðŸ§  Vector Embeddings**: Real-time embedding generation using sentence-transformers
- **ðŸ”Ž Vector Search**: Hybrid search combining similarity and filtering
- **ðŸ’¬ RAG Query**: Interactive Q&A with source attribution
- **ðŸŽ¯ Sample Data**: Pre-loaded sample documents for immediate testing

## ðŸš€ Quick Start

1. **Load Sample Data**: Click "Load Sample Data" to get started immediately
2. **Upload Documents**: Add your own documents via the file upload
3. **Process Documents**: Chunk and embed your documents
4. **Ask Questions**: Use the RAG interface to query your documents

## ðŸ›ï¸ Architecture Benefits

- **Clean Separation**: Domain, Application, and Infrastructure layers are clearly separated
- **Testability**: Comprehensive test coverage with Unit, Integration, and E2E tests
- **Maintainability**: Easy to modify and extend functionality
- **Scalability**: Ready for production deployment

## ðŸ§ª Testing

This application includes:
- **Unit Tests**: 52+ tests covering core business logic
- **Integration Tests**: Service integration and basic execution tests
- **E2E Tests**: Playwright-based user scenario tests

## ðŸ”§ Technical Stack

- **Backend**: Python, FastAPI, Gradio
- **AI/ML**: sentence-transformers, LangChain
- **Architecture**: Hexagonal Architecture (Ports & Adapters)
- **Testing**: pytest, Playwright
- **Deployment**: Docker, HuggingFace Spaces

---

*Built with â¤ï¸ using Hexagonal Architecture principles*
EOF
        
        # Validate all required files are present
        echo "ðŸ“‹ Validating deployment files..."
        for file in "main.py" "README.md" "Dockerfile" "requirements.txt"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing deployment file: $file"
            exit 1
          fi
          echo "âœ… Ready: $file"
        done
        
        # Show directory structure for debugging
        echo "ðŸ“ Final directory structure:"
        find . -type f -name "*.py" | head -20
        
    - name: Deploy to HuggingFace Spaces
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_USERNAME: ${{ secrets.HF_USERNAME }}
      run: |
        cd ai-service/demo
        python -c "
        from huggingface_hub import HfApi, create_repo
        import os
        
        api = HfApi(token=os.environ['HF_TOKEN'])
        repo_id = f\"{os.environ['HF_USERNAME']}/ai-portfolio-rag-demo\"
        
        print(f'ðŸš€ Deploying Hexagonal Architecture RAG Demo to {repo_id}')
        
        try:
            # Create space if it doesn't exist
            create_repo(
                repo_id=repo_id,
                repo_type='space',
                space_sdk='gradio',
                token=os.environ['HF_TOKEN'],
                exist_ok=True
            )
            print(f'âœ… Space {repo_id} ready')
            
            # Upload Hexagonal Architecture files
            api.upload_folder(
                folder_path='.',
                repo_id=repo_id,
                repo_type='space',
                token=os.environ['HF_TOKEN'],
                ignore_patterns=[
                    '__pycache__', 
                    '*.pyc', 
                    'docker-compose*', 
                    'Dockerfile.dev*',
                    'tests/',
                    '.pytest_cache',
                    'config.yaml',
                    'test_*.py',
                    'node_modules/',
                    '*.log'
                ]
            )
            print(f'âœ… Hexagonal Architecture files uploaded to {repo_id}')
            
            # Verify key files were uploaded
            files = api.list_repo_files(repo_id=repo_id, repo_type='space')
            required_files = ['main.py', 'README.md', 'requirements.txt', 'Dockerfile']
            
            missing_files = [f for f in required_files if f not in files]
            if missing_files:
                raise Exception(f'Missing required files: {missing_files}')
            
            print(f'âœ… All required files verified: {required_files}')
            
        except Exception as e:
            print(f'âŒ Deployment failed: {e}')
            raise e
        "
        
    - name: Verify Deployment
      run: |
        echo "ðŸŽ‰ Hexagonal Architecture RAG Demo deployed successfully!"
        echo ""
        echo "ðŸ”— Demo URL: https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/ai-portfolio-rag-demo"
        echo "âš™ï¸  Settings: https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/ai-portfolio-rag-demo/settings"
        echo "ðŸ“Š Logs: https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/ai-portfolio-rag-demo/logs"
        echo ""
        echo "âœ¨ Demo Features:"
        echo "  â€¢ ðŸ—ï¸ Hexagonal Architecture (Ports & Adapters)"
        echo "  â€¢ ðŸ§  Real vector embeddings (sentence-transformers)"
        echo "  â€¢ ðŸ“š Interactive document processing"
        echo "  â€¢ ðŸ” Live RAG pipeline demonstration"
        echo "  â€¢ ðŸ§ª Comprehensive test coverage (Unit + Integration + E2E)"
        echo "  â€¢ ðŸŽ­ Playwright E2E testing"
        echo "  â€¢ ðŸ“Š Test coverage reporting"
        echo "  â€¢ ðŸš€ CI/CD automated deployment"
        echo "  â€¢ ðŸ”’ Production-ready security"
        echo ""
        echo "ðŸš€ The demo will be available in 2-3 minutes at the URL above!"
        echo ""
        echo "ðŸ“ˆ Test Results Summary:"
        echo "  â€¢ Unit Tests: âœ… Passed"
        echo "  â€¢ Integration Tests: âœ… Passed" 
        echo "  â€¢ E2E Tests: âœ… Passed"
        echo "  â€¢ Coverage: Uploaded to Codecov"
        echo "  â€¢ Playwright Reports: Uploaded as artifacts"