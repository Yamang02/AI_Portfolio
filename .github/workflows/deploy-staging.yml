name: Deploy to Staging

on:
  push:
    branches: [ develop, staging ]
    paths:
      - 'frontend/**'
      - 'backend/**' 
      - 'Dockerfile'
      - '.github/workflows/deploy-staging.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'Dockerfile'

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_MAIN_SERVICE_NAME: ${{ vars.GCP_MAIN_SERVICE_NAME }}
  GCP_MAIN_REGION: ${{ vars.GCP_MAIN_REGION }}
  VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Build and skip tests (DB not available in CI)
      run: |
        cd backend
        mvn clean package -DskipTests
  
  deploy:
    needs: test
    runs-on: ubuntu-latest
    environment: staging  # GitHub Environment 사용
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Build application
      run: |
        cd backend
        mvn clean package -DskipTests
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Configure Docker to use gcloud as a credential helper
      run: gcloud auth configure-docker
    
    - name: Build and push Docker image
      run: |
        docker build \
          --build-arg VITE_API_BASE_URL=$VITE_API_BASE_URL \
          -t gcr.io/$GCP_PROJECT_ID/$GCP_MAIN_SERVICE_NAME:$GITHUB_SHA .
        docker push gcr.io/$GCP_PROJECT_ID/$GCP_MAIN_SERVICE_NAME:$GITHUB_SHA
    
    - name: Deploy AI Portfolio to Cloud Run Staging
      run: |
        gcloud run deploy $GCP_MAIN_SERVICE_NAME \
          --image gcr.io/$GCP_PROJECT_ID/$GCP_MAIN_SERVICE_NAME:$GITHUB_SHA \
          --platform managed \
          --region $GCP_MAIN_REGION \
          --allow-unauthenticated \
          --set-env-vars="SPRING_PROFILES_ACTIVE=${{ vars.SPRING_PROFILES_ACTIVE }}" \
          --set-env-vars="DATABASE_URL=${{ secrets.DATABASE_URL }}" \
          --set-env-vars="GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" \
          --set-env-vars="REDIS_HOST=${{ vars.REDIS_HOST }}" \
          --set-env-vars="REDIS_PORT=${{ vars.REDIS_PORT }}" \
          --set-env-vars="REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" \
          --set-env-vars="REDIS_DB_IDX=0" \
          --set-env-vars="REDIS_KEY_PREFIX=main-staging:" \
          --set-env-vars="REDIS_SSL=${{ vars.REDIS_SSL }}" \
          --memory 1Gi \
          --cpu 1 \
          --max-instances 10 \
          --timeout 900 \
          --cpu-boost \
          --startup-probe="httpGet.path=/actuator/health,httpGet.port=8080,initialDelaySeconds=60,timeoutSeconds=10,periodSeconds=15,failureThreshold=8"

  # 프론트엔드 배포는 백엔드 Docker에서 통합 처리하므로 제거
  # 백엔드 Docker 이미지에 프론트엔드 정적 파일이 포함됨